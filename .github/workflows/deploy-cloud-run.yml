name: Deploy to GCP Cloud Run

on:
  push:
    branches:
      - main  # Trigger only when code is pushed to the main branch

env:
  PROJECT_ID: geoharness               # Matches SA: geoharness@geoharness.iam.gserviceaccount.com
  REGION: asia-northeast3             # Seoul region
  SERVICE_NAME: geoharness-api

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --dev

      - name: Run Unit Tests
        run: uv run pytest tests/ -v

  deploy:
    needs: test
    runs-on: ubuntu-latest
    
    # Required for Workload Identity Federation (GCP authentication without keys)
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # 1. Auth into GCP via Workload Identity Federation (Secure Way) OR Service Account JSON
      # Assuming you set GCP_CREDENTIALS secret in Github repo settings containing the SA JSON key
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'
          
      # 2. Setup Google Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        
      # 3. Build & Deploy to Cloud Run using the local Dockerfile
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          project_id: ${{ env.PROJECT_ID }}
          source: .
          # Assuming you set the API Keys as secrets in Github Repo settings
          env_vars: |
            GOOGLE_MAPS_KEY=${{ secrets.GOOGLE_MAPS_KEY }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
            NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
            NAVER_SEARCH_CLIENT_ID=${{ secrets.NAVER_SEARCH_CLIENT_ID }}
            NAVER_SEARCH_CLIENT_SECRET=${{ secrets.NAVER_SEARCH_CLIENT_SECRET }}
            VWORLD_API_KEY=${{ secrets.VWORLD_API_KEY }}
          flags: '--allow-unauthenticated'

      # 4. Show debug logs on failure
      - name: Show Cloud Run & Build logs
        if: failure()
        run: |
          echo "=== Cloud Run Service Logs ==="
          gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=${{ env.SERVICE_NAME }}" \
            --project=${{ env.PROJECT_ID }} --limit=50 --format="value(textPayload)" 2>/dev/null || \
          echo "Could not retrieve Cloud Run logs"

          echo ""
          echo "=== Cloud Build Log ==="
          BUILD_ID=$(gcloud builds list --project=${{ env.PROJECT_ID }} --region=${{ env.REGION }} --limit=1 --format="value(id)" 2>/dev/null || true)
          if [ -n "$BUILD_ID" ]; then
            gcloud builds log "$BUILD_ID" --project=${{ env.PROJECT_ID }} --region=${{ env.REGION }} 2>/dev/null || \
            gcloud builds log "$BUILD_ID" --project=${{ env.PROJECT_ID }} 2>/dev/null || \
            echo "Could not retrieve build logs."
          fi

