name: Deploy to GCP Cloud Run

on:
  push:
    branches:
      - main  # Trigger only when code is pushed to the main branch

env:
  PROJECT_ID: geoharness-mvp          # REPLACE with your actual GCP Project ID
  REGION: asia-northeast3             # Seoul region
  SERVICE_NAME: geoharness-api

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --dev

      - name: Run Unit Tests
        run: uv run pytest tests/ -v

  deploy:
    needs: test
    runs-on: ubuntu-latest
    
    # Required for Workload Identity Federation (GCP authentication without keys)
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # 1. Auth into GCP via Workload Identity Federation (Secure Way) OR Service Account JSON
      # Assuming you set GCP_CREDENTIALS secret in Github repo settings containing the SA JSON key
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'
          
      # 2. Setup Google Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        
      # 3. Build & Deploy to Cloud Run using the local Dockerfile
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          source: .
          # Assuming you set the API Keys as secrets in Github Repo settings 
          env_vars: |
            GOOGLE_MAPS_KEY=${{ secrets.GOOGLE_MAPS_KEY }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
            NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
            VWORLD_API_KEY=${{ secrets.VWORLD_API_KEY }}
          flags: '--allow-unauthenticated'

